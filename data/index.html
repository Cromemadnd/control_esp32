<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>户外移动电源 - 控制台</title>
    <link href="tailwind.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

<body class="bg-slate-900 text-slate-100 font-sans min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1
                    class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                    电力实时监控系统
                </h1>
                <div class="text-slate-400 mt-2 flex flex-wrap items-center gap-4 text-sm">
                    <span id="connection-status" class="flex items-center gap-2">
                        <span id="status-icon"></span>
                        状态: <span id="status-text">正在初始化...</span>
                    </span>
                    <span id="last-update" class="opacity-60 hidden">更新于: --:--:--</span>
                </div>
            </div>
        </header>

        <!-- 电池电量 (通栏) -->
        <div
            class="col-span-1 md:col-span-2 lg:col-span-3 bg-slate-800/40 rounded-2xl p-6 border border-emerald-500/20 backdrop-blur-sm mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-400"><svg width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect width="16" height="10" x="2" y="7" rx="2" ry="2" />
                            <line x1="22" x2="22" y1="11" y2="13" />
                        </svg></div>
                    <h3 class="text-lg font-medium text-slate-300">储备电池电量</h3>
                </div>
                <span id="val-battery-text" class="text-3xl font-bold text-emerald-400">0%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
                <div id="battery-bar" class="h-full bg-emerald-500 transition-all duration-1000 ease-out"
                    style="width: 0%"></div>
            </div>
        </div>

        <!-- 错误警告条 -->
        <div id="error-banner"
            class="hidden mb-6 bg-red-500/10 border border-red-500/50 text-red-400 p-4 rounded-xl flex items-start gap-3">
            <svg class="w-5 h-5 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" x2="12" y1="8" y2="12" />
                <line x1="12" x2="12.01" y1="16" y2="16" />
            </svg>
            <p id="error-text" class="text-sm"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- 1. 系统控制面板 (新增) -->
            <div
                class="col-span-1 lg:col-span-1 bg-slate-800/60 rounded-2xl p-6 border border-slate-700 backdrop-blur-sm">
                <h3 class="text-slate-300 font-bold mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    系统控制
                </h3>

                <div class="space-y-6">
                    <!-- 屏显开关 -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-400">屏显开关</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ctrl-screen" class="sr-only peer"
                                onchange="sendControl('screen', this.checked)">
                            <div
                                class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>

                    <!-- 交流输出开关 -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-400">交流输出控制</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ctrl-ac-out" class="sr-only peer"
                                onchange="sendControl('ac_output', this.checked)">
                            <div
                                class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600">
                            </div>
                        </label>
                    </div>

                    <!-- 灯条亮度 -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-400">灯条亮度调节</span>
                            <span id="val-brightness-text" class="text-xs font-mono text-blue-400">50%</span>
                        </div>
                        <input type="range" id="ctrl-brightness" min="0" max="100" value="50"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                            oninput="updateBrightnessUI(this.value)"
                            onchange="sendControl('brightness', parseInt(this.value))">
                    </div>
                </div>
            </div>

            <!-- 数据展示列 -->
            <div class="col-span-1 lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 稳压反馈 -->
                <div class="bg-slate-800/40 rounded-2xl p-6 border border-blue-500/30 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4 text-blue-400">
                        <div class="p-2 bg-slate-700/50 rounded-lg"><svg width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="16" height="16" x="4" y="4" rx="2" />
                                <rect width="6" height="6" x="9" y="9" rx="1" />
                                <path d="M15 2v2M15 20v2M2 15h2M2 9h2M20 15h2M20 9h2M9 2v2M9 20v2" />
                            </svg></div>
                        <h3 class="text-slate-400 font-medium">稳压反馈</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="val-voltage" class="text-4xl font-bold text-white">0.00</span><span
                            class="text-lg text-slate-500">V</span>
                    </div>
                </div>

                <!-- 市电电压 -->
                <div class="bg-slate-800/40 rounded-2xl p-6 border border-yellow-500/30 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4 text-yellow-400">
                        <div class="p-2 bg-slate-700/50 rounded-lg"><svg width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                            </svg></div>
                        <h3 class="text-slate-400 font-medium">市电电压</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="val-ac_voltage" class="text-4xl font-bold text-white">0.00</span><span
                            class="text-lg text-slate-500">V</span>
                    </div>
                </div>

                <!-- 环境温度 -->
                <div class="bg-slate-800/40 rounded-2xl p-6 border border-red-500/30 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4 text-red-400">
                        <div class="p-2 bg-slate-700/50 rounded-lg"><svg width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z" />
                            </svg></div>
                        <h3 class="text-slate-400 font-medium">环境温度</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="val-temperature" class="text-4xl font-bold text-white">0.0</span><span
                            class="text-lg text-slate-500">°C</span>
                    </div>
                </div>

                <!-- 母线电流 -->
                <div class="bg-slate-800/40 rounded-2xl p-6 border border-orange-500/30 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4 text-orange-400">
                        <div class="p-2 bg-slate-700/50 rounded-lg"><svg width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg></div>
                        <h3 class="text-slate-400 font-medium">母线电流</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="val-current" class="text-4xl font-bold text-white">0.00</span><span
                            class="text-lg text-slate-500">A</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-slate-600 text-xs">
            户外移动电源 © 2025 控制算法
        </footer>
    </div>

    <script>
        let protocol = 'ws';
        let socket = null;
        let reconnectTimer = null;

        const ICONS = {
            check: '<svg class="w-4 h-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>',
            refresh: '<svg class="w-4 h-4 text-blue-500 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>',
            alert: '<svg class="w-4 h-4 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>'
        };

        function setStatus(type, text) {
            document.getElementById('status-text').innerText = text;
            document.getElementById('status-icon').innerHTML = ICONS[type === 'connected' ? 'check' : type === 'connecting' ? 'refresh' : 'alert'];
        }

        function setProtocol(p) {
            if (protocol === p) return;
            protocol = p;
            document.getElementById('btn-ws').className = p === 'ws' ? 'px-3 py-1 rounded-md text-xs transition bg-blue-600 text-white' : 'px-3 py-1 rounded-md text-xs transition text-slate-400 hover:text-white';
            document.getElementById('btn-wss').className = p === 'wss' ? 'px-3 py-1 rounded-md text-xs transition bg-blue-600 text-white' : 'px-3 py-1 rounded-md text-xs transition text-slate-400 hover:text-white';
            document.getElementById('endpoint-display').innerText = `${p}://192.168.4.1/ws`;
            if (socket) socket.close();
            connect();
        }

        // 更新亮度 UI 文字（不涉及网络发送）
        function updateBrightnessUI(val) {
            document.getElementById('val-brightness-text').innerText = `${val}%`;
        }

        // 发送控制指令
        function sendControl(target, value) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const payload = {
                    type: "control",
                    target: target,
                    value: value,
                    timestamp: Date.now()
                };
                socket.send(JSON.stringify(payload));
                console.log("Sent command:", payload);
            } else {
                console.warn("WebSocket is not connected. Command ignored.");
            }
        }

        function updateUI(data) {
            document.getElementById('val-voltage').innerText = data.voltage.toFixed(2);
            document.getElementById('val-ac_voltage').innerText = data.ac_voltage.toFixed(2);
            document.getElementById('val-current').innerText = data.current.toFixed(2);
            document.getElementById('val-temperature').innerText = data.temperature.toFixed(1);

            const batteryPercent = Math.round(data.battery * 100);
            const batteryText = document.getElementById('val-battery-text');
            const batteryBar = document.getElementById('battery-bar');
            batteryText.innerText = `${batteryPercent}%`;
            batteryBar.style.width = `${Math.max(0, Math.min(100, batteryPercent))}%`;

            if (batteryPercent <= 20) {
                batteryText.classList.replace('text-emerald-400', 'text-red-500');
                batteryBar.classList.replace('bg-emerald-500', 'bg-red-500');
                batteryBar.classList.add('animate-pulse-slow');
            } else {
                batteryText.classList.replace('text-red-500', 'text-emerald-400');
                batteryBar.classList.replace('bg-red-500', 'bg-emerald-500');
                batteryBar.classList.remove('animate-pulse-slow');
            }

            const lastUpdate = document.getElementById('last-update');
            lastUpdate.innerText = `更新于: ${new Date().toLocaleTimeString()}`;
            lastUpdate.classList.remove('hidden');
        }

        function connect() {
            if (reconnectTimer) clearTimeout(reconnectTimer);
            const url = `${protocol}://192.168.4.1/ws`;
            const errorBanner = document.getElementById('error-banner');
            setStatus('connecting', '正在连接...');
            errorBanner.classList.add('hidden');

            try {
                socket = new WebSocket(url);
                socket.onopen = () => setStatus('connected', '已连接');
                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        // 如果后端返回的是状态数据则更新 UI
                        if (data.voltage !== undefined) updateUI(data);
                    } catch (e) { }
                };
                socket.onclose = () => {
                    setStatus('disconnected', '连接已断开，5秒后重连');
                    reconnectTimer = setTimeout(connect, 5000);
                };
                socket.onerror = (err) => console.error('WS Error');
            } catch (err) {
                setStatus('error', '连接异常');
                if (err.name === 'SecurityError') {
                    document.getElementById('error-text').innerText = '安全错误：HTTPS 页面无法访问 ws://。请使用 WSS。';
                    errorBanner.classList.remove('hidden');
                }
            }
        }

        window.addEventListener('load', connect);
    </script>
</body>

</html>